#
# Additional configuration for llama.cpp and RAG service
# This file is loaded by IncludeOptional conf.d/*.conf
#

#
# Listen on port 8443 for HTTPS
#
Listen 0.0.0.0:8443

#
# SSL Session Cache (must be defined before VirtualHost)
#
<IfModule ssl_module>
    SSLSessionCache "shmcb:/run/httpd/ssl_scache(512000)"
    SSLSessionCacheTimeout 300

    # SSL Protocol and Cipher settings
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
</IfModule>

#
# HTTP VirtualHost (port 8080)
# Redirect to HTTPS
#
#<VirtualHost *:8080>
#    <IfModule rewrite_module>
#        RewriteEngine On
#        RewriteCond %{HTTPS} off
#        RewriteRule ^(.*)$ https://%{HTTP_HOST}:8443%{REQUEST_URI} [L,R=301]
#    </IfModule>
#</VirtualHost>

#
# HTTPS VirtualHost (port 8443)
#
<VirtualHost *:8443>
    <IfModule ssl_module>
        SSLEngine on
        SSLCertificateFile /etc/httpd/certs/server.crt
        SSLCertificateKeyFile /etc/httpd/certs/server.key
    </IfModule>

    #
    # Security headers
    #
    <IfModule headers_module>
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "DENY"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
    </IfModule>

    #
    # Static files - exclude from proxy
    #
    ProxyPass        "/html/"      !
    ProxyPassReverse "/html/"      !

    Alias /html/ "/var/www/html/"
    <Directory "/var/www/html/">
        Require all granted
        Options Indexes FollowSymLinks

        # MIME types for static files
        AddType text/html .html
        AddType text/css .css
        AddType application/javascript .js
        AddType application/json .json
        AddType image/x-icon .ico
        AddType image/png .png
        AddType image/jpeg .jpg .jpeg
        AddType image/gif .gif
        AddType image/svg+xml .svg
    </Directory>

    #
    # RAG service proxy
    #
    <IfModule proxy_module>
        ProxyPass /rag/ http://rag-service:8080/
        ProxyPassReverse /rag/ http://rag-service:8080/

        # Default proxy to llama-cpp-server (must be last)
        ProxyPreserveHost On
        ProxyPass / http://llama-cpp-server:11434/
        ProxyPassReverse / http://llama-cpp-server:11434/
    </IfModule>

    #
    # WebSocket support
    #
    <IfModule mod_proxy_wstunnel.c>
        ProxyPass /socket.io ws://llama-cpp-server:11434/socket.io
        ProxyPassReverse /socket.io ws://llama-cpp-server:11434/socket.io
    </IfModule>

    <IfModule rewrite_module>
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) "ws://llama-cpp-server:11434/$1" [P,L]
    </IfModule>

    #
    # Basic Authentication
    #
    <Location />
        AuthType Basic
        AuthName "llama.cpp API"
        AuthUserFile "/etc/httpd/.htpasswd"
        <LimitExcept OPTIONS>
            Require valid-user
        </LimitExcept>
    </Location>

</VirtualHost>
